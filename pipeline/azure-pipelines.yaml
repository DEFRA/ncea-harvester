# Starter pipeline

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - feature/* 

variables:
  - template: templates/variables-build.yml
  - name : isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name : isPullRequest
    value: $[eq(variables['Build.Reason'], 'PullRequest')]
  - name : branchSource
    value: $[replace(variables['Build.SourceBranch'], 'refs/heads/', '')]
  - name : branch
    value: $[replace(variables['branchSource'], '/', '-')]
  - ${{ if ne(variables.isMain, 'true') }}:
    - name : artifactNameSuffix
      value: _$(branch)
  - ${{ else }}:
    - name : artifactNameSuffix
      value: ''  
  - name : chartPath
    value: 'src/ncea-harvester/ncea-harvester'
  - name : containerRespository
    value: 'defra/ncea-harvester-service'
  - name : imageTag
    value: $(Build.BuildNumber)$(artifactNameSuffix)

stages:
- stage: 'Build'
  displayName: 'Build Harvester Service'
  jobs: 
  - job: 'Build'
    displayName: 'Build job'
    pool:
      vmImage: 'ubuntu-latest'
      
    steps:
      - template: steps-build-and-test.yaml
      - template: steps-build-and-push-docker-images.yaml
      - template: steps-package-and-push-helm-charts.yaml

- stage: 'sandbox'
  displayName: 'Deploy to Sandbox'
  dependsOn: Build
  condition:  and(succeeded(), eq(variables.isPullRequest, true))
  variables:
   - template: templates/variables-sandbox.yml
  jobs:
  - deployment: Deploy
    pool:
      vmImage: 'ubuntu-latest'
    environment: sandbox 
    strategy:
      runOnce:
        deploy:
          steps:
            - template: steps-deploy-helm-charts.yaml
              parameters:
                envName: sandbox
                releaseName: ncea-harvester-sandbox

- stage: 'dev'
  displayName: 'Deploy to Dev'
  dependsOn: Build
  condition:  and(succeeded(), eq(variables.isMain, true))
  variables:
   - template: templates/variables-dev.yml
  jobs:
  - deployment: Deploy
    pool:
      vmImage: 'ubuntu-latest'
    environment: dev 
    strategy:
      runOnce:
        deploy:
          steps:
            - template: steps-deploy-helm-charts.yaml
              parameters:
                envName: dev
                releaseName: ncea-harvester-dev