parameters:
  - name: envName
    type: string
  - name: namespace
    type: string
  - name: releaseName
    type: string
  - name: serviceConnection
    type: string

steps:

- task: HelmDeploy@0
  displayName: 'Helm Deploy'
  condition: and(succeeded(), eq(variables.isPullRequest, false))
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceConnection: ${{ parameters.serviceConnection }}
    namespace: default
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: '$(Build.ArtifactStagingDirectory)/ncea-harvester-$(Build.BuildNumber).tgz'
    valueFile: $(chartPath)/values/values.${{ parameters.envName }}.yaml
    overrideValues: 'image.tag=$(Build.BuildNumber)$(artifactNameSuffix)'
    install: true
    recreate: true
    force: true
    releaseName: ${{ parameters.releaseName }}